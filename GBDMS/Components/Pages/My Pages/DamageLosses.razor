@page "/losses"
@inject IJSRuntime JS

<div class="container-fluid">
    <h2 class="mb-4">Damage and Losses Assessment</h2>

    <div class="row">
        <!-- Filters and Summary Panel -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Filter and Summary</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Disaster Type</label>
                        <select class="form-select" @bind="selectedDisasterType">
                            <option value="">All Disaster Types</option>
                            <option value="Earthquake">Earthquake</option>
                            <option value="Flood">Flood</option>
                            <option value="Landslide">Landslide</option>
                            <option value="Avalanche">Avalanche</option>
                            <option value="GLOF">Glacial Lake Outburst Flood</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">District</label>
                        <select class="form-select" @bind="selectedDistrict">
                            <option value="">All Districts</option>
                            <option value="Gilgit">Gilgit</option>
                            <option value="Skardu">Skardu</option>
                            <option value="Hunza">Hunza</option>
                            <option value="Astore">Astore</option>
                            <option value="Ghanche">Ghanche</option>
                            <option value="Ghizer">Ghizer</option>
                            <option value="Nagar">Nagar</option>
                            <option value="Shigar">Shigar</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">From</span>
                            <input type="date" class="form-control" @bind="startDate">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">To</span>
                            <input type="date" class="form-control" @bind="endDate">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Damage Category</label>
                        <select class="form-select" @bind="selectedCategory">
                            <option value="">All Categories</option>
                            <option value="Infrastructure">Infrastructure</option>
                            <option value="Housing">Housing</option>
                            <option value="Agriculture">Agriculture</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Education">Education</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <button class="btn btn-primary w-100" @onclick="ApplyFilters">
                        <i class="bi bi-funnel-fill"></i> Apply Filters
                    </button>
                    
                    <hr />
                    
                    <div class="summary-stats">
                        <h6 class="text-muted mb-3">Summary Statistics</h6>
                        
                        <div class="stat-box total-damage">
                            <div class="stat-label">Total Financial Loss</div>
                            <div class="stat-value">PKR @totalFinancialLoss.ToString("N0")</div>
                        </div>
                        
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <div class="stat-box">
                                    <div class="stat-label">Total Incidents</div>
                                    <div class="stat-value">@filteredDamageList.Count</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-box">
                                    <div class="stat-label">Verified Records</div>
                                    <div class="stat-value">@filteredDamageList.Count(d => d.IsVerified)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6 class="text-muted">Damage Distribution</h6>
                            <div class="progress" style="height: 24px;">
                                @foreach (var category in categoryDistribution)
                                {
                                    <div class="progress-bar @GetCategoryColor(category.Key)" 
                                         role="progressbar" 
                                         style="width: @(category.Value)%" 
                                         title="@category.Key: @(category.Value)%">
                                        @if (category.Value >= 10)
                                        {
                                            @(category.Value)@("%")
                                        }
                                    </div>
                                }
                            </div>
                            <div class="category-legend mt-2">
                                @foreach (var category in categoryDistribution)
                                {
                                    <div class="category-item">
                                        <span class="category-color @GetCategoryColor(category.Key)"></span>
                                        <span class="category-name">@category.Key</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Damage Records and Form -->
        <div class="col-md-8">
            <!-- Entry Form -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Record New Damage/Loss</h5>
                    <button class="btn btn-sm btn-light" @onclick="ToggleForm">
                        @(showForm ? "Close" : "Add New")
                    </button>
                </div>
                @if (showForm)
                {
                    <div class="card-body">
                        <form>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Title/Description</label>
                                        <input type="text" class="form-control" @bind="newDamage.Title" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Disaster Type</label>
                                        <select class="form-select" @bind="newDamage.DisasterType" required>
                                            <option value="">Select Type</option>
                                            <option value="Earthquake">Earthquake</option>
                                            <option value="Flood">Flood</option>
                                            <option value="Landslide">Landslide</option>
                                            <option value="Avalanche">Avalanche</option>
                                            <option value="GLOF">Glacial Lake Outburst Flood</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">District</label>
                                        <select class="form-select" @bind="newDamage.District" required>
                                            <option value="">Select District</option>
                                            <option value="Gilgit">Gilgit</option>
                                            <option value="Skardu">Skardu</option>
                                            <option value="Hunza">Hunza</option>
                                            <option value="Astore">Astore</option>
                                            <option value="Ghanche">Ghanche</option>
                                            <option value="Ghizer">Ghizer</option>
                                            <option value="Nagar">Nagar</option>
                                            <option value="Shigar">Shigar</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Specific Location</label>
                                        <input type="text" class="form-control" @bind="newDamage.Location">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Date of Incident</label>
                                        <input type="date" class="form-control" @bind="newDamage.Date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Damage Category</label>
                                        <select class="form-select" @bind="newDamage.Category" required>
                                            <option value="">Select Category</option>
                                            <option value="Infrastructure">Infrastructure</option>
                                            <option value="Housing">Housing</option>
                                            <option value="Agriculture">Agriculture</option>
                                            <option value="Healthcare">Healthcare</option>
                                            <option value="Education">Education</option>
                                            <option value="Commercial">Commercial</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Financial Loss (PKR)</label>
                                        <input type="number" class="form-control" @bind="newDamage.FinancialLoss" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Severity</label>
                                        <select class="form-select" @bind="newDamage.Severity">
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Severe">Severe</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Detailed Description</label>
                                <textarea class="form-control" rows="3" @bind="newDamage.Description"></textarea>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="verifiedCheck" @bind="newDamage.IsVerified">
                                <label class="form-check-label" for="verifiedCheck">
                                    Verified by Authority
                                </label>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" @onclick="ResetForm">Clear</button>
                                <button type="button" class="btn btn-success" @onclick="AddDamageRecord">Save Record</button>
                            </div>
                        </form>
                    </div>
                }
            </div>
            
            <!-- Damage Records Table -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Damage and Loss Records</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>District</th>
                                    <th>Financial Loss</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (filteredDamageList.Count == 0)
                                {
                                    <tr>
                                        <td colspan="8" class="text-center py-3">No damage records found.</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var damage in filteredDamageList)
                                    {
                                        <tr>
                                            <td>@damage.Date.ToString("yyyy-MM-dd")</td>
                                            <td>@damage.Title</td>
                                            <td>
                                                <span class="badge rounded-pill @GetCategoryBadgeClass(damage.Category)">
                                                    @damage.Category
                                                </span>
                                            </td>
                                            <td>@damage.District</td>
                                            <td>PKR @damage.FinancialLoss.ToString("N0")</td>
                                            <td>
                                                <span class="badge bg-@GetSeverityBadgeClass(damage.Severity)">
                                                    @damage.Severity
                                                </span>
                                            </td>
                                            <td>
                                                @if (damage.IsVerified)
                                                {
                                                    <span class="badge bg-success">Verified</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning text-dark">Pending</span>
                                                }
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-info me-1" @onclick="() => ViewDetails(damage)">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteRecord(damage)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (selectedDamage != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Damage Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Title:</strong> @selectedDamage.Title</p>
                            <p><strong>Category:</strong> @selectedDamage.Category</p>
                            <p><strong>Disaster Type:</strong> @selectedDamage.DisasterType</p>
                            <p><strong>Date:</strong> @selectedDamage.Date.ToString("yyyy-MM-dd")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>District:</strong> @selectedDamage.District</p>
                            <p><strong>Location:</strong> @selectedDamage.Location</p>
                            <p><strong>Financial Loss:</strong> PKR @selectedDamage.FinancialLoss.ToString("N0")</p>
                            <p><strong>Severity:</strong> @selectedDamage.Severity</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Detailed Description</h6>
                        <p>@selectedDamage.Description</p>
                    </div>
                    
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="modalVerifiedCheck" 
                               @bind="selectedDamage.IsVerified"
                               @onclick="UpdateVerificationStatus">
                        <label class="form-check-label" for="modalVerifiedCheck">
                            <strong>Verified by Authority</strong>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    </div>
}

@code {
    // Filter properties
    private string selectedDisasterType = "";
    private string selectedDistrict = "";
    private string selectedCategory = "";
    private DateTime startDate = DateTime.Now.AddMonths(-1);
    private DateTime endDate = DateTime.Now;
    
    // Form properties
    private DamageRecord newDamage = new();
    private bool showForm = false;
    
    // Data properties
    private List<DamageRecord> damageList = new();
    private List<DamageRecord> filteredDamageList = new();
    private double totalFinancialLoss = 0;
    private Dictionary<string, double> categoryDistribution = new();
    
    // Modal properties
    private DamageRecord? selectedDamage;
    
    protected override void OnInitialized()
    {
        // Initialize with sample data
        InitializeSampleData();
        
        // Apply initial filters
        ApplyFilters();
    }
    
    private void InitializeSampleData()
    {
        var random = new Random();
        
        damageList = new List<DamageRecord>
        {
            new DamageRecord
            {
                Id = 1,
                Title = "Bridge Collapse in Gilgit City",
                DisasterType = "Flood",
                District = "Gilgit",
                Location = "Central Gilgit, Janbaaz Bridge",
                Date = DateTime.Now.AddDays(-25),
                Category = "Infrastructure",
                FinancialLoss = 15000000,
                Severity = "High",
                Description = "The main bridge connecting the eastern and western parts of Gilgit city collapsed due to heavy flooding. The bridge was already in poor condition and needs complete reconstruction.",
                IsVerified = true
            },
            new DamageRecord
            {
                Id = 2,
                Title = "Agricultural Lands Damaged in Ghizer",
                DisasterType = "Flood",
                District = "Ghizer",
                Location = "Phandar Valley",
                Date = DateTime.Now.AddDays(-18),
                Category = "Agriculture",
                FinancialLoss = 4500000,
                Severity = "Medium",
                Description = "Approximately 120 acres of fertile agricultural land was damaged by flash floods. Crops including wheat, potatoes, and vegetables were completely destroyed just before harvest season.",
                IsVerified = true
            },
            new DamageRecord
            {
                Id = 3,
                Title = "Primary School Building Damaged",
                DisasterType = "Earthquake",
                District = "Skardu",
                Location = "Shighar Area",
                Date = DateTime.Now.AddDays(-12),
                Category = "Education",
                FinancialLoss = 7800000,
                Severity = "Medium",
                Description = "The main building of Government Primary School was significantly damaged with cracks in walls and ceiling. The building needs major repairs before it can be used safely.",
                IsVerified = false
            },
            new DamageRecord
            {
                Id = 4,
                Title = "Residential Area Affected by Landslide",
                DisasterType = "Landslide",
                District = "Hunza",
                Location = "Nagar Valley, Northern Area",
                Date = DateTime.Now.AddDays(-8),
                Category = "Housing",
                FinancialLoss = 22500000,
                Severity = "Severe",
                Description = "A major landslide destroyed 12 houses completely and damaged 18 others. Approximately 30 families were displaced and need immediate housing assistance.",
                IsVerified = true
            },
            new DamageRecord
            {
                Id = 5,
                Title = "Hospital Equipment Damaged",
                DisasterType = "Flood",
                District = "Astore",
                Location = "District Hospital",
                Date = DateTime.Now.AddDays(-5),
                Category = "Healthcare",
                FinancialLoss = 9200000,
                Severity = "High",
                Description = "Flooding in the basement of the district hospital damaged critical medical equipment including generators, X-ray machines, and laboratory equipment.",
                IsVerified = false
            },
            new DamageRecord
            {
                Id = 6,
                Title = "Market Area Damaged by Fire",
                DisasterType = "Other",
                District = "Gilgit",
                Location = "Central Market",
                Date = DateTime.Now.AddDays(-3),
                Category = "Commercial",
                FinancialLoss = 35000000,
                Severity = "Severe",
                Description = "A fire that started in one shop quickly spread to nearby buildings, affecting 28 shops in the central market area. Major goods and property were damaged.",
                IsVerified = true
            },
            new DamageRecord
            {
                Id = 7,
                Title = "Road Network Damaged by Avalanche",
                DisasterType = "Avalanche",
                District = "Ghanche",
                Location = "Khaplu-Skardu Road",
                Date = DateTime.Now.AddDays(-15),
                Category = "Infrastructure",
                FinancialLoss = 12500000,
                Severity = "High",
                Description = "A major avalanche blocked and damaged approximately 3 km stretch of the road connecting Khaplu to Skardu. Road needs major repairs and protective structures.",
                IsVerified = true
            }
        };
    }
    
    private void ApplyFilters()
    {
        filteredDamageList = damageList.Where(d =>
            (string.IsNullOrEmpty(selectedDisasterType) || d.DisasterType == selectedDisasterType) &&
            (string.IsNullOrEmpty(selectedDistrict) || d.District == selectedDistrict) &&
            (string.IsNullOrEmpty(selectedCategory) || d.Category == selectedCategory) &&
            (d.Date >= startDate && d.Date <= endDate)
        ).ToList();
        
        // Calculate total financial loss
        totalFinancialLoss = filteredDamageList.Sum(d => d.FinancialLoss);
        
        // Calculate category distribution
        CalculateCategoryDistribution();
    }
    
    private void CalculateCategoryDistribution()
    {
        categoryDistribution = new Dictionary<string, double>();
        
        if (filteredDamageList.Count == 0)
            return;
            
        var groupedCategories = filteredDamageList
            .GroupBy(d => d.Category)
            .Select(g => new { Category = g.Key, Count = g.Count() });
            
        foreach (var item in groupedCategories)
        {
            double percentage = Math.Round((double)item.Count / filteredDamageList.Count * 100, 1);
            categoryDistribution.Add(item.Category, percentage);
        }
    }
    
    private void ToggleForm()
    {
        showForm = !showForm;
        if (showForm)
        {
            ResetForm();
        }
    }
    
    private void ResetForm()
    {
        newDamage = new DamageRecord
        {
            Date = DateTime.Now,
            Severity = "Medium",
            IsVerified = false
        };
    }
    
    private void AddDamageRecord()
    {
        if (string.IsNullOrWhiteSpace(newDamage.Title) || 
            string.IsNullOrWhiteSpace(newDamage.DisasterType) ||
            string.IsNullOrWhiteSpace(newDamage.District) ||
            string.IsNullOrWhiteSpace(newDamage.Category))
        {
            // Display validation error
            return;
        }
        
        // Generate new Id
        newDamage.Id = damageList.Count > 0 ? damageList.Max(d => d.Id) + 1 : 1;
        
        // Add to list
        damageList.Add(newDamage);
        
        // Apply filters to update the view
        ApplyFilters();
        
        // Reset the form
        ResetForm();
        
        // Hide the form
        showForm = false;
    }
    
    private void ViewDetails(DamageRecord damage)
    {
        selectedDamage = damage;
    }
    
    private void CloseDetailsModal()
    {
        selectedDamage = null;
    }
    
    private void DeleteRecord(DamageRecord damage)
    {
        damageList.Remove(damage);
        filteredDamageList.Remove(damage);
        ApplyFilters();
    }
    
    private void UpdateVerificationStatus()
    {
        // Find the original record and update it
        var record = damageList.FirstOrDefault(d => d.Id == selectedDamage.Id);
        if (record != null)
        {
            record.IsVerified = selectedDamage.IsVerified;
        }
    }
    
    private string GetCategoryBadgeClass(string category)
    {
        return category switch
        {
            "Infrastructure" => "bg-primary",
            "Housing" => "bg-success",
            "Agriculture" => "bg-success text-dark",
            "Healthcare" => "bg-danger",
            "Education" => "bg-warning text-dark",
            "Commercial" => "bg-info text-dark",
            _ => "bg-secondary"
        };
    }
    
    private string GetCategoryColor(string category)
    {
        return category switch
        {
            "Infrastructure" => "bg-primary",
            "Housing" => "bg-success",
            "Agriculture" => "bg-success",
            "Healthcare" => "bg-danger",
            "Education" => "bg-warning",
            "Commercial" => "bg-info",
            _ => "bg-secondary"
        };
    }
    
    private string GetSeverityBadgeClass(string severity)
    {
        return severity switch
        {
            "Low" => "success",
            "Medium" => "warning",
            "High" => "danger",
            "Severe" => "dark",
            _ => "secondary"
        };
    }
    
    private class DamageRecord
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string DisasterType { get; set; } = "";
        public string District { get; set; } = "";
        public string Location { get; set; } = "";
        public DateTime Date { get; set; } = DateTime.Now;
        public string Category { get; set; } = "";
        public double FinancialLoss { get; set; } = 0;
        public string Severity { get; set; } = "Medium";
        public string Description { get; set; } = "";
        public bool IsVerified { get; set; } = false;
    }
}
